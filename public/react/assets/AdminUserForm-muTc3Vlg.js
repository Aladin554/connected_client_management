import{m as A,u as C,r as n,i as E,d as x,j as a}from"./index-BVvtZPCr.js";import{A as $}from"./arrow-left-C0Ez98bG.js";import"./createLucideIcon-BB7Ogyrb.js";const w=m=>{const o=/^(?:(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)\.){3}(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)$/,c=/^[0-9A-Fa-f:]+$/;return o.test(m)||m.includes(":")&&c.test(m)};function L(){const{id:m}=A(),o=C(),c=!!m,[d,v]=n.useState(null),[s,u]=n.useState({first_name:"",last_name:"",email:"",roleId:c?"":"3",password:"",max_cards:"10",allowed_ips:[]}),[l,p]=n.useState({first_name:"",last_name:"",email:"",roleId:"",password:"",max_cards:"",allowed_ips:""}),[f,b]=n.useState(""),[y,h]=n.useState(!1),[k,j]=n.useState([]);n.useEffect(()=>{E().then(e=>{v(e)}).catch(()=>{o("/dashboard/admin-users",{state:{message:"Failed to get current user",type:"error"}})})},[o]),n.useEffect(()=>{if(!d)return;const e=d.role_id,r=d.can_create_users===1;e!==1&&(e===2&&r||o("/dashboard/admin-users",{state:{message:"You do not have access to this page.",type:"error"}}))},[d,o]),n.useEffect(()=>{x.get("/roles").then(e=>j(Array.isArray(e.data)?e.data:[])).catch(()=>o("/dashboard/admin-users",{state:{message:"Failed to fetch roles",type:"error"}}))},[o]),n.useEffect(()=>{c&&m&&x.get(`/users/${m}`).then(e=>{var r,i,t,g;u({first_name:e.data.first_name||"",last_name:e.data.last_name||"",email:e.data.email||"",roleId:((r=e.data.role_id)==null?void 0:r.toString())||((t=(i=e.data.role)==null?void 0:i.id)==null?void 0:t.toString())||"",password:"",max_cards:((g=e.data.max_cards)==null?void 0:g.toString())||"10",allowed_ips:Array.isArray(e.data.allowed_ips)?e.data.allowed_ips:[]})}).catch(()=>o("/dashboard/admin-users",{state:{message:"Failed to load user",type:"error"}}))},[m,c,o]);const N=()=>{const e={first_name:"",last_name:"",email:"",roleId:"",password:"",max_cards:"",allowed_ips:""};let r=!0;if(s.first_name.trim()||(e.first_name="First name is required.",r=!1),s.last_name.trim()||(e.last_name="Last name is required.",r=!1),s.email.trim()?/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s.email)||(e.email="Invalid email address.",r=!1):(e.email="Email is required.",r=!1),s.roleId||(e.roleId="Role is required.",r=!1),!c&&!s.password.trim()&&(e.password="Password is required.",r=!1),(d==null?void 0:d.role_id)===1){const i=parseInt(s.max_cards);(isNaN(i)||i<1||i>1e3)&&(e.max_cards="Max cards must be between 1 and 1000",r=!1),s.allowed_ips.some(t=>!w(t))&&(e.allowed_ips="One or more IPs are invalid.",r=!1)}return p(e),r},_=()=>{const e=f.trim();if(!e)return;const r=e.split(/[,\s]+/).map(t=>t.trim()).filter(Boolean);if(r.length===0)return;const i=r.find(t=>!w(t));if(i){p(t=>({...t,allowed_ips:`Invalid IP: ${i}`}));return}u(t=>({...t,allowed_ips:Array.from(new Set([...t.allowed_ips,...r]))})),p(t=>({...t,allowed_ips:""})),b("")},I=e=>{u(r=>({...r,allowed_ips:r.allowed_ips.filter(i=>i!==e)}))},S=async e=>{var r,i;if(e.preventDefault(),!!N()){h(!0);try{const t={first_name:s.first_name,last_name:s.last_name,email:s.email,role_id:Number(s.roleId)};s.password&&(t.password=s.password),(d==null?void 0:d.role_id)===1&&(t.max_cards=Number(s.max_cards)),(d==null?void 0:d.role_id)===1&&(t.allowed_ips=s.allowed_ips),c?(await x.put(`/users/${m}`,t),o("/dashboard/admin-users",{state:{message:"User updated successfully!",type:"success"}})):(await x.post("/users",t),o("/dashboard/admin-users",{state:{message:"User added successfully!",type:"success"}}))}catch(t){const g=((i=(r=t.response)==null?void 0:r.data)==null?void 0:i.message)||"Error saving user";o("/dashboard/admin-users",{state:{message:g,type:"error"}})}finally{h(!1)}}};return a.jsxs("div",{className:"p-16 border border-gray-200 rounded-2xl dark:border-gray-700 dark:bg-gray-900 shadow-sm max-w-5xl mx-auto w-full",children:[a.jsxs("button",{type:"button",onClick:()=>o(-1),className:"inline-flex items-center gap-2 px-3 py-2 mb-6 rounded-xl border border-gray-300 dark:border-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 hover:border-gray-400 dark:hover:border-gray-600 transition-all duration-200 shadow-sm",children:[a.jsx($,{className:"w-5 h-5"}),a.jsx("span",{className:"font-medium",children:"Back"})]}),a.jsx("h1",{className:"text-2xl font-semibold mb-6 dark:text-gray-200",children:c?"Edit User":"Add New User"}),a.jsxs("form",{onSubmit:S,className:"space-y-6 w-full",children:[a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-8",children:[a.jsxs("div",{children:[a.jsx("label",{className:"block mb-1 text-sm font-medium dark:text-gray-300",children:"First Name"}),a.jsx("input",{type:"text",value:s.first_name,onChange:e=>u({...s,first_name:e.target.value}),className:`w-full border px-3 py-2 rounded-lg text-lg dark:bg-gray-700 dark:text-gray-200 focus:outline-none focus:ring-2 ${l.first_name?"border-red-500 focus:ring-red-500":"focus:ring-blue-500"}`}),l.first_name&&a.jsx("p",{className:"text-red-500 text-sm mt-1",children:l.first_name})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block mb-1 text-sm font-medium dark:text-gray-300",children:"Last Name"}),a.jsx("input",{type:"text",value:s.last_name,onChange:e=>u({...s,last_name:e.target.value}),className:`w-full border px-3 py-2 rounded-lg text-lg dark:bg-gray-700 dark:text-gray-200 focus:outline-none focus:ring-2 ${l.last_name?"border-red-500 focus:ring-red-500":"focus:ring-blue-500"}`}),l.last_name&&a.jsx("p",{className:"text-red-500 text-sm mt-1",children:l.last_name})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block mb-1 text-sm font-medium dark:text-gray-300",children:"Email"}),a.jsx("input",{type:"email",value:s.email,onChange:e=>u({...s,email:e.target.value}),className:`w-full border px-3 py-2 rounded-lg text-lg dark:bg-gray-700 dark:text-gray-200 focus:outline-none focus:ring-2 ${l.email?"border-red-500 focus:ring-red-500":"focus:ring-blue-500"}`}),l.email&&a.jsx("p",{className:"text-red-500 text-sm mt-1",children:l.email})]}),a.jsxs("div",{children:[a.jsxs("label",{className:"block mb-1 text-sm font-medium dark:text-gray-300",children:["Password ",c&&"(leave blank to keep unchanged)"]}),a.jsx("input",{type:"password",value:s.password,onChange:e=>u({...s,password:e.target.value}),className:`w-full border px-3 py-2 rounded-lg text-lg dark:bg-gray-700 dark:text-gray-200 focus:outline-none focus:ring-2 ${l.password?"border-red-500 focus:ring-red-500":"focus:ring-blue-500"}`}),l.password&&a.jsx("p",{className:"text-red-500 text-sm mt-1",children:l.password})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block mb-1 text-sm font-medium dark:text-gray-300",children:"Role"}),a.jsxs("select",{value:s.roleId,onChange:e=>u({...s,roleId:e.target.value}),className:`w-full border px-3 py-2 rounded-lg text-lg dark:bg-gray-700 dark:text-gray-200 focus:outline-none focus:ring-2 ${l.roleId?"border-red-500 focus:ring-red-500":"focus:ring-blue-500"}`,children:[a.jsx("option",{value:"",children:"Select role"}),k.map(e=>a.jsx("option",{value:e.id,children:e.name},e.id))]}),l.roleId&&a.jsx("p",{className:"text-red-500 text-sm mt-1",children:l.roleId})]}),(d==null?void 0:d.role_id)===1&&a.jsxs("div",{className:"md:col-span-2",children:[a.jsx("label",{className:"block mb-1 text-sm font-medium dark:text-gray-300",children:"Allowed IPs (User-wise security)"}),a.jsx("div",{className:"flex flex-wrap gap-2 mb-2",children:s.allowed_ips.map(e=>a.jsxs("span",{className:"inline-flex items-center gap-2 rounded-md bg-blue-50 px-2 py-1 text-xs font-medium text-blue-800",children:[e,a.jsx("button",{type:"button",onClick:()=>I(e),className:"text-blue-700 hover:text-blue-900",children:"x"})]},e))}),a.jsxs("div",{className:"flex gap-2",children:[a.jsx("input",{type:"text",value:f,onChange:e=>b(e.target.value),onKeyDown:e=>{e.key==="Enter"&&(e.preventDefault(),_())},placeholder:"Add IP (e.g. 203.0.113.10)",className:"w-full border px-3 py-2 rounded-lg text-lg dark:bg-gray-700 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500"}),a.jsx("button",{type:"button",onClick:_,className:"px-4 py-2 rounded-lg border dark:border-gray-600 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-800",children:"Add"})]}),l.allowed_ips&&a.jsx("p",{className:"text-red-500 text-sm mt-1",children:l.allowed_ips})]})]}),a.jsxs("div",{className:"flex justify-end gap-3 mt-8",children:[a.jsx("button",{type:"button",onClick:()=>o("/dashboard/admin-users"),className:"px-5 py-2 rounded-lg border dark:border-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800",children:"Cancel"}),a.jsx("button",{type:"submit",disabled:y,className:"px-6 py-3 rounded-lg bg-blue-600 text-white hover:bg-blue-700 text-lg disabled:opacity-50",children:y?"Saving...":"Save User"})]})]})]})}export{L as default};
