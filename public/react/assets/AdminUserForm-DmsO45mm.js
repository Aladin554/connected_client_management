import{m as C,u as E,r as m,i as $,d as x,j as a}from"./index-dlF-v8Wy.js";import{A as F}from"./arrow-left-BbdkQ8F7.js";import"./createLucideIcon-Ck__ep5g.js";const v=c=>{const o=/^(?:(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)\.){3}(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)$/,n=/^[0-9A-Fa-f:]+$/;return o.test(c)||c.includes(":")&&n.test(c)};function R(){const{id:c}=C(),o=E(),n=!!c,[r,k]=m.useState(null),[s,u]=m.useState({first_name:"",last_name:"",email:"",roleId:"",password:"",max_cards:"10",allowed_ips:[]}),[d,p]=m.useState({first_name:"",last_name:"",email:"",roleId:"",password:"",max_cards:"",allowed_ips:""}),[f,b]=m.useState(""),[y,h]=m.useState(!1),[j,N]=m.useState([]),_=(r==null?void 0:r.role_id)===1||(r==null?void 0:r.role_id)===2&&Number(r==null?void 0:r.can_create_users)===1;m.useEffect(()=>{$({force:!0}).then(e=>{k(e)}).catch(()=>{o("/dashboard/admin-users",{state:{message:"Failed to get current user",type:"error"}})})},[o]),m.useEffect(()=>{if(!r)return;const e=r.role_id,t=r.can_create_users===1;e!==1&&(e===2&&(n||t)||o("/dashboard/admin-users",{state:{message:"You do not have access to this page.",type:"error"}}))},[r,n,o]),m.useEffect(()=>{x.get("/roles").then(e=>N(Array.isArray(e.data)?e.data:[])).catch(()=>o("/dashboard/admin-users",{state:{message:"Failed to fetch roles",type:"error"}}))},[o]),m.useEffect(()=>{n&&c&&x.get(`/users/${c}`).then(e=>{var t,i,l,g;u({first_name:e.data.first_name||"",last_name:e.data.last_name||"",email:e.data.email||"",roleId:((t=e.data.role_id)==null?void 0:t.toString())||((l=(i=e.data.role)==null?void 0:i.id)==null?void 0:l.toString())||"",password:"",max_cards:((g=e.data.max_cards)==null?void 0:g.toString())||"10",allowed_ips:Array.isArray(e.data.allowed_ips)?e.data.allowed_ips:[]})}).catch(()=>o("/dashboard/admin-users",{state:{message:"Failed to load user",type:"error"}}))},[c,n,o]);const I=()=>{const e={first_name:"",last_name:"",email:"",roleId:"",password:"",max_cards:"",allowed_ips:""};let t=!0;if(s.first_name.trim()||(e.first_name="First name is required.",t=!1),s.last_name.trim()||(e.last_name="Last name is required.",t=!1),s.email.trim()?/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s.email)||(e.email="Invalid email address.",t=!1):(e.email="Email is required.",t=!1),s.roleId||(e.roleId="Role is required.",t=!1),!n&&!s.password.trim()&&(e.password="Password is required.",t=!1),(r==null?void 0:r.role_id)===1){const i=parseInt(s.max_cards);(isNaN(i)||i<1||i>1e3)&&(e.max_cards="Max cards must be between 1 and 1000",t=!1),s.allowed_ips.some(l=>!v(l))&&(e.allowed_ips="One or more IPs are invalid.",t=!1)}return p(e),t},w=()=>{const e=f.trim();if(!e)return;const t=e.split(/[,\s]+/).map(l=>l.trim()).filter(Boolean);if(t.length===0)return;const i=t.find(l=>!v(l));if(i){p(l=>({...l,allowed_ips:`Invalid IP: ${i}`}));return}u(l=>({...l,allowed_ips:Array.from(new Set([...l.allowed_ips,...t]))})),p(l=>({...l,allowed_ips:""})),b("")},A=e=>{u(t=>({...t,allowed_ips:t.allowed_ips.filter(i=>i!==e)}))},S=async e=>{var t,i;if(e.preventDefault(),!n&&!_){o("/dashboard/admin-users",{state:{message:"Add user permission is inactive.",type:"error"}});return}if(I()){h(!0);try{const l={first_name:s.first_name,last_name:s.last_name,email:s.email,role_id:Number(s.roleId)};s.password&&(l.password=s.password),(r==null?void 0:r.role_id)===1&&(l.max_cards=Number(s.max_cards)),(r==null?void 0:r.role_id)===1&&(l.allowed_ips=s.allowed_ips),n?(await x.put(`/users/${c}`,l),o("/dashboard/admin-users",{state:{message:"User updated successfully!",type:"success"}})):(await x.post("/users",l),o("/dashboard/admin-users",{state:{message:"User added successfully!",type:"success"}}))}catch(l){const g=((i=(t=l.response)==null?void 0:t.data)==null?void 0:i.message)||"Error saving user";o("/dashboard/admin-users",{state:{message:g,type:"error"}})}finally{h(!1)}}};return a.jsxs("div",{className:"p-16 border border-gray-200 rounded-2xl dark:border-gray-700 dark:bg-gray-900 shadow-sm max-w-5xl mx-auto w-full",children:[a.jsxs("button",{type:"button",onClick:()=>o(-1),className:"inline-flex items-center gap-2 px-3 py-2 mb-6 rounded-xl border border-gray-300 dark:border-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 hover:border-gray-400 dark:hover:border-gray-600 transition-all duration-200 shadow-sm",children:[a.jsx(F,{className:"w-5 h-5"}),a.jsx("span",{className:"font-medium",children:"Back"})]}),a.jsx("h1",{className:"text-2xl font-semibold mb-6 dark:text-gray-200",children:n?"Edit User":"Add New User"}),a.jsxs("form",{onSubmit:S,className:"space-y-6 w-full",children:[a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-8",children:[a.jsxs("div",{children:[a.jsx("label",{className:"block mb-1 text-sm font-medium dark:text-gray-300",children:"First Name"}),a.jsx("input",{type:"text",value:s.first_name,onChange:e=>u({...s,first_name:e.target.value}),className:`w-full border px-3 py-2 rounded-lg text-lg dark:bg-gray-700 dark:text-gray-200 focus:outline-none focus:ring-2 ${d.first_name?"border-red-500 focus:ring-red-500":"focus:ring-blue-500"}`}),d.first_name&&a.jsx("p",{className:"text-red-500 text-sm mt-1",children:d.first_name})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block mb-1 text-sm font-medium dark:text-gray-300",children:"Last Name"}),a.jsx("input",{type:"text",value:s.last_name,onChange:e=>u({...s,last_name:e.target.value}),className:`w-full border px-3 py-2 rounded-lg text-lg dark:bg-gray-700 dark:text-gray-200 focus:outline-none focus:ring-2 ${d.last_name?"border-red-500 focus:ring-red-500":"focus:ring-blue-500"}`}),d.last_name&&a.jsx("p",{className:"text-red-500 text-sm mt-1",children:d.last_name})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block mb-1 text-sm font-medium dark:text-gray-300",children:"Email"}),a.jsx("input",{type:"email",value:s.email,onChange:e=>u({...s,email:e.target.value}),className:`w-full border px-3 py-2 rounded-lg text-lg dark:bg-gray-700 dark:text-gray-200 focus:outline-none focus:ring-2 ${d.email?"border-red-500 focus:ring-red-500":"focus:ring-blue-500"}`}),d.email&&a.jsx("p",{className:"text-red-500 text-sm mt-1",children:d.email})]}),a.jsxs("div",{children:[a.jsxs("label",{className:"block mb-1 text-sm font-medium dark:text-gray-300",children:["Password ",n&&"(leave blank to keep unchanged)"]}),a.jsx("input",{type:"password",value:s.password,onChange:e=>u({...s,password:e.target.value}),className:`w-full border px-3 py-2 rounded-lg text-lg dark:bg-gray-700 dark:text-gray-200 focus:outline-none focus:ring-2 ${d.password?"border-red-500 focus:ring-red-500":"focus:ring-blue-500"}`}),d.password&&a.jsx("p",{className:"text-red-500 text-sm mt-1",children:d.password})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block mb-1 text-sm font-medium dark:text-gray-300",children:"Role"}),a.jsxs("select",{value:s.roleId,onChange:e=>u({...s,roleId:e.target.value}),className:`w-full border px-3 py-2 rounded-lg text-lg dark:bg-gray-700 dark:text-gray-200 focus:outline-none focus:ring-2 ${d.roleId?"border-red-500 focus:ring-red-500":"focus:ring-blue-500"}`,children:[a.jsx("option",{value:"",children:"Select role"}),j.map(e=>a.jsx("option",{value:e.id,children:e.name},e.id))]}),d.roleId&&a.jsx("p",{className:"text-red-500 text-sm mt-1",children:d.roleId})]}),(r==null?void 0:r.role_id)===1&&a.jsxs("div",{className:"md:col-span-2",children:[a.jsx("label",{className:"block mb-1 text-sm font-medium dark:text-gray-300",children:"Allowed IPs (User-wise security)"}),a.jsx("div",{className:"flex flex-wrap gap-2 mb-2",children:s.allowed_ips.map(e=>a.jsxs("span",{className:"inline-flex items-center gap-2 rounded-md bg-blue-50 px-2 py-1 text-xs font-medium text-blue-800",children:[e,a.jsx("button",{type:"button",onClick:()=>A(e),className:"text-blue-700 hover:text-blue-900",children:"x"})]},e))}),a.jsxs("div",{className:"flex gap-2",children:[a.jsx("input",{type:"text",value:f,onChange:e=>b(e.target.value),onKeyDown:e=>{e.key==="Enter"&&(e.preventDefault(),w())},placeholder:"Add IP (e.g. 203.0.113.10)",className:"w-full border px-3 py-2 rounded-lg text-lg dark:bg-gray-700 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500"}),a.jsx("button",{type:"button",onClick:w,className:"px-4 py-2 rounded-lg border dark:border-gray-600 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-800",children:"Add"})]}),d.allowed_ips&&a.jsx("p",{className:"text-red-500 text-sm mt-1",children:d.allowed_ips})]})]}),a.jsxs("div",{className:"flex justify-end gap-3 mt-8",children:[a.jsx("button",{type:"button",onClick:()=>o("/dashboard/admin-users"),className:"px-5 py-2 rounded-lg border dark:border-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800",children:"Cancel"}),a.jsx("button",{type:"submit",disabled:y||!n&&!_,className:"px-6 py-3 rounded-lg bg-blue-600 text-white hover:bg-blue-700 text-lg disabled:opacity-50",children:y?"Saving...":"Save User"})]})]})]})}export{R as default};
