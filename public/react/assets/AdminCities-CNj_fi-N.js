import{r as d,j as s,l as ne,d as x,y as o}from"./index-DNhL7Y25.js";import{P as O}from"./plus-CE6BtWri.js";import{S as oe}from"./square-pen-BAlnmBzi.js";import{T as ce}from"./trash-2-0mdN-OPl.js";import{X as me}from"./x-CIRX2IQL.js";import"./createLucideIcon-YXB1pq23.js";function ye(){const[c,q]=d.useState([]),[y,I]=d.useState([]),[T,X]=d.useState([]),[G,$]=d.useState(!0),[u,H]=d.useState(""),[J,z]=d.useState([]),[m,C]=d.useState(""),[g,f]=d.useState([]),[b,j]=d.useState([]),[w,h]=d.useState([]),[K,N]=d.useState(!1),[k,A]=d.useState(null),[v,S]=d.useState(""),[B,p]=d.useState([""]),[Q,D]=d.useState(!1),[L,_]=d.useState(null);d.useEffect(()=>{(async()=>{$(!0),await Promise.all([E(),F(),V()]),$(!1)})()},[]);const E=async()=>{try{const e=await x.get("/cities");q(e.data||[])}catch{o.error("Failed to load cities")}},F=async()=>{try{const r=(await x.get("/users")).data.map(t=>({...t,board_lists:t.board_lists||[]}));I(r)}catch{o.error("Failed to load users")}},V=async()=>{try{const e=await x.get("/roles");X(e.data||[])}catch{o.error("Failed to load roles")}};d.useEffect(()=>{if(!u){z([]),C(""),P();return}const e=y.filter(r=>{var t;return((t=r.role)==null?void 0:t.id)===u});z(e),C(""),P()},[u,y]),d.useEffect(()=>{var r,t,i;if(!m){P();return}const e=y.find(a=>a.id===m);e&&(f(((r=e.cities)==null?void 0:r.map(a=>a.id))||[]),j(((t=e.boards)==null?void 0:t.map(a=>a.id))||[]),h(((i=e.board_lists)==null?void 0:i.map(a=>a.id))||[]))},[m,y]);const P=()=>{f([]),j([]),h([])},W=e=>{f(r=>{if(r.includes(e)){const t=c.find(n=>n.id===e);if(!t)return r;const i=t.boards.map(n=>n.id),a=t.boards.flatMap(n=>{var l;return((l=n.lists)==null?void 0:l.map(U=>U.id))||[]});return j(n=>n.filter(l=>!i.includes(l))),h(n=>n.filter(l=>!a.includes(l))),r.filter(n=>n!==e)}return[...r,e]})},Y=e=>{j(r=>{var i;if(r.includes(e)){const a=c.flatMap(l=>l.boards).find(l=>l.id===e),n=((i=a==null?void 0:a.lists)==null?void 0:i.map(l=>l.id))||[];return h(l=>l.filter(U=>!n.includes(U))),r.filter(l=>l!==e)}const t=c.find(a=>a.boards.some(n=>n.id===e));return t&&!g.includes(t.id)&&f(a=>[...a,t.id]),[...r,e]})},Z=e=>{h(r=>r.includes(e)?r.filter(t=>t!==e):[...r,e])},ee=async()=>{if(m)try{await Promise.all([x.patch(`/users/${m}/cities`,{cities:g}),x.patch(`/users/${m}/boards`,{boards:b}),x.patch(`/users/${m}/lists`,{lists:w})]),o.success("Permissions updated"),F()}catch{o.error("Failed to save permissions")}},se=()=>{A(null),S(""),p([""]),N(!0)},R=e=>{A(e),S(e.name),p(e.boards.map(r=>r.name)),N(!0)},re=async()=>{var r,t;if(!v.trim()){o.error("City name is required");return}const e=B.filter(i=>i.trim()!=="");try{k?(await x.put(`/cities/${k.id}`,{name:v.trim(),boards:e}),o.success("City updated")):(await x.post("/cities",{name:v.trim(),boards:e}),o.success("City created")),N(!1),E()}catch(i){o.error(((t=(r=i.response)==null?void 0:r.data)==null?void 0:t.message)||"Failed to save city")}},te=e=>{_(e),D(!0)},ae=async()=>{if(L)try{await x.delete(`/cities/${L}`),o.success("City deleted"),E()}catch{o.error("Failed to delete city")}finally{D(!1),_(null)}},de=()=>{p(e=>[...e,""])},le=e=>{p(r=>r.filter((t,i)=>i!==e))},ie=(e,r)=>{p(t=>t.map((i,a)=>a===e?r:i))},M=e=>e?new Date(e).toLocaleDateString():"—";return G?s.jsx("div",{className:"p-10 text-center text-gray-500",children:"Loading cities & users..."}):s.jsxs("div",{className:"p-5 lg:p-6 bg-white dark:bg-gray-900 rounded-2xl border border-gray-200 dark:border-gray-700 max-w-[1100px] mx-auto",children:[s.jsx(ne,{position:"top-right",autoClose:3e3,theme:"colored"}),s.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6",children:[s.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-gray-100",children:"Cities & Access Control"}),s.jsxs("button",{onClick:se,className:"flex items-center gap-2 px-5 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition",children:[s.jsx(O,{size:18})," New City"]})]}),s.jsxs("div",{className:"mb-10 p-5 border rounded-xl bg-gray-50/50 dark:bg-gray-800/40 dark:border-gray-700",children:[s.jsx("h2",{className:"text-lg font-semibold mb-4 text-gray-800 dark:text-gray-200",children:"Assign Permissions"}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-5 mb-6",children:[s.jsxs("div",{children:[s.jsx("label",{className:"block mb-1.5 font-medium text-gray-700 dark:text-gray-300",children:"Role"}),s.jsxs("select",{value:u,onChange:e=>H(Number(e.target.value)||""),className:"w-full px-4 py-2.5 border rounded-lg dark:bg-gray-800 dark:border-gray-700 dark:text-gray-200 focus:ring-2 focus:ring-blue-500",children:[s.jsx("option",{value:"",children:"— Select Role —"}),T.map(e=>s.jsx("option",{value:e.id,children:e.name},e.id))]})]}),u&&s.jsxs("div",{children:[s.jsx("label",{className:"block mb-1.5 font-medium text-gray-700 dark:text-gray-300",children:"User"}),s.jsxs("select",{value:m,onChange:e=>C(Number(e.target.value)||""),className:"w-full px-4 py-2.5 border rounded-lg dark:bg-gray-800 dark:border-gray-700 dark:text-gray-200 focus:ring-2 focus:ring-blue-500",children:[s.jsx("option",{value:"",children:"— Select User —"}),J.map(e=>s.jsxs("option",{value:e.id,children:[e.first_name," ",e.last_name," • ",e.email]},e.id))]})]})]}),m&&s.jsxs("div",{className:"space-y-7",children:[s.jsxs("div",{children:[s.jsx("h3",{className:"font-medium mb-2.5 text-gray-800 dark:text-gray-200",children:"Cities"}),s.jsx("div",{className:"flex flex-wrap gap-2.5",children:c.map(e=>s.jsxs("label",{className:`flex items-center gap-2 px-4 py-2 border rounded-lg cursor-pointer text-sm transition-all ${g.includes(e.id)?"bg-blue-100 border-blue-400 dark:bg-blue-950/50 dark:border-blue-600":"hover:bg-gray-100 dark:hover:bg-gray-800 border-gray-300 dark:border-gray-600"}`,children:[s.jsx("input",{type:"checkbox",checked:g.includes(e.id),onChange:()=>W(e.id),className:"h-4 w-4 rounded text-blue-600"}),s.jsx("span",{className:"font-medium",children:e.name}),s.jsxs("span",{className:"text-xs text-gray-500 dark:text-gray-400",children:["(",e.boards.length,")"]})]},e.id))})]}),g.length>0&&s.jsxs("div",{children:[s.jsx("h3",{className:"font-medium mb-2.5 text-gray-800 dark:text-gray-200",children:"Boards"}),c.filter(e=>g.includes(e.id)).map(e=>s.jsxs("div",{className:"mb-5 pl-4 border-l-2 border-gray-200 dark:border-gray-700",children:[s.jsx("p",{className:"font-medium text-gray-700 dark:text-gray-300 mb-2",children:e.name}),s.jsx("div",{className:"flex flex-wrap gap-2.5",children:e.boards.map(r=>s.jsxs("label",{className:`flex items-center gap-2 px-4 py-2 border rounded-lg cursor-pointer text-sm transition-all ${b.includes(r.id)?"bg-indigo-100 border-indigo-400 dark:bg-indigo-950/50 dark:border-indigo-600":"hover:bg-gray-100 dark:hover:bg-gray-800 border-gray-300 dark:border-gray-600"}`,children:[s.jsx("input",{type:"checkbox",checked:b.includes(r.id),onChange:()=>Y(r.id),className:"h-4 w-4 rounded text-indigo-600"}),s.jsx("span",{children:r.name})]},r.id))})]},e.id))]}),b.length>0&&s.jsxs("div",{children:[s.jsx("h3",{className:"font-medium mb-2.5 text-gray-800 dark:text-gray-200",children:"Lists"}),c.flatMap(e=>e.boards).filter(e=>b.includes(e.id)).map(e=>s.jsxs("div",{className:"mb-5 pl-8",children:[s.jsx("p",{className:"text-sm font-medium text-gray-600 dark:text-gray-400 mb-1.5",children:e.name}),s.jsx("div",{className:"flex flex-wrap gap-2.5",children:(e.lists||[]).map(r=>s.jsxs("label",{className:`flex items-center gap-2 px-4 py-2 border rounded-lg cursor-pointer text-sm transition-all ${w.includes(r.id)?"bg-purple-100 border-purple-400 dark:bg-purple-950/50 dark:border-purple-600":"hover:bg-gray-100 dark:hover:bg-gray-800 border-gray-300 dark:border-gray-600"}`,children:[s.jsx("input",{type:"checkbox",checked:w.includes(r.id),onChange:()=>Z(r.id),className:"h-4 w-4 rounded text-purple-600"}),s.jsx("span",{children:r.title})]},r.id))})]},e.id))]}),s.jsx("button",{onClick:ee,className:"px-6 py-2.5 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition",children:"Save Permissions"})]})]}),s.jsx("div",{className:"overflow-x-auto rounded-xl border border-gray-200 dark:border-gray-700",children:s.jsxs("table",{className:"min-w-full bg-white dark:bg-gray-900",children:[s.jsx("thead",{className:"bg-gray-50 dark:bg-gray-800 border-b",children:s.jsxs("tr",{children:[s.jsx("th",{className:"px-6 py-4 text-left border-r",children:"City Name"}),s.jsx("th",{className:"px-6 py-4 text-left border-r",children:"Boards"}),s.jsx("th",{className:"px-6 py-4 text-left border-r",children:"Created"}),s.jsx("th",{className:"px-6 py-4 text-left border-r",children:"Updated"}),s.jsx("th",{className:"px-6 py-4 text-left",children:"Action"})]})}),s.jsx("tbody",{children:c.length===0?s.jsx("tr",{children:s.jsx("td",{colSpan:5,className:"px-6 py-10 text-center text-gray-500 dark:text-gray-400",children:"No cities found"})}):c.map(e=>s.jsxs("tr",{className:"border-t",children:[s.jsx("td",{className:"px-6 py-4 border-r",children:e.name}),s.jsx("td",{className:"px-6 py-4 border-r",children:e.boards.map(r=>r.name).join(", ")||"—"}),s.jsx("td",{className:"px-6 py-4 border-r",children:M(e.created_at)}),s.jsx("td",{className:"px-6 py-4 border-r",children:M(e.updated_at)}),s.jsxs("td",{className:"px-6 py-4 flex gap-2",children:[s.jsx("button",{onClick:()=>R(e),className:"p-2 bg-yellow-100 hover:bg-yellow-200 rounded dark:bg-yellow-900/40 dark:hover:bg-yellow-800/60",title:"Edit",children:s.jsx(oe,{size:16,className:"text-yellow-700 dark:text-yellow-400"})}),s.jsx("button",{onClick:()=>te(e.id),className:"p-2 bg-red-100 hover:bg-red-200 rounded dark:bg-red-900/40 dark:hover:bg-red-800/60",title:"Delete",children:s.jsx(ce,{size:16,className:"text-red-700 dark:text-red-400"})})]})]},e.id))})]})}),K&&s.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:s.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl p-6 w-[420px]",children:[s.jsx("h3",{className:"text-xl font-bold mb-4",children:k?"Edit City":"Add City"}),!k&&s.jsxs("select",{value:"new",onChange:e=>{if(e.target.value!=="new"){const r=c.find(t=>t.id===Number(e.target.value));r&&R(r)}},className:"w-full mb-4 px-4 py-2 border rounded dark:bg-gray-800 dark:border-gray-700 dark:text-gray-200",children:[s.jsx("option",{value:"new",children:"Create New City"}),c.map(e=>s.jsx("option",{value:e.id,children:e.name},e.id))]}),s.jsx("input",{value:v,onChange:e=>S(e.target.value),className:"w-full mb-4 px-4 py-2 border rounded dark:bg-gray-800 dark:border-gray-700 dark:text-gray-200",placeholder:"City name"}),s.jsxs("div",{className:"mb-4",children:[s.jsx("p",{className:"font-medium mb-2",children:"Boards"}),B.map((e,r)=>s.jsxs("div",{className:"flex gap-2 mb-2",children:[s.jsx("input",{value:e,onChange:t=>ie(r,t.target.value),className:"flex-1 px-3 py-2 border rounded dark:bg-gray-800 dark:border-gray-700 dark:text-gray-200",placeholder:`Board ${r+1}`}),B.length>1&&s.jsx("button",{onClick:()=>le(r),className:"p-2 bg-red-100 hover:bg-red-200 rounded dark:bg-red-900/40 dark:hover:bg-red-800/50",children:s.jsx(me,{size:14})})]},r)),s.jsxs("button",{onClick:de,className:"text-sm text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 mt-2 flex items-center gap-1",children:[s.jsx(O,{size:14})," Add Board"]})]}),s.jsxs("div",{className:"flex gap-3",children:[s.jsx("button",{onClick:()=>N(!1),className:"flex-1 border py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 dark:border-gray-600",children:"Cancel"}),s.jsx("button",{onClick:re,className:"flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded font-medium",children:"Save"})]})]})}),Q&&s.jsx("div",{className:"fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4",children:s.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl p-6 w-full max-w-sm",children:[s.jsx("h3",{className:"text-lg font-bold mb-4",children:"Confirm Delete"}),s.jsxs("p",{className:"mb-6 text-gray-700 dark:text-gray-300",children:["Delete this city?",s.jsx("br",{}),s.jsx("span",{className:"text-red-600 font-medium",children:"All boards and lists will be permanently removed."})]}),s.jsxs("div",{className:"flex gap-3",children:[s.jsx("button",{onClick:()=>D(!1),className:"flex-1 py-2.5 border rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700",children:"Cancel"}),s.jsx("button",{onClick:ae,className:"flex-1 bg-red-600 hover:bg-red-700 text-white py-2.5 rounded-lg font-medium",children:"Delete"})]})]})})]})}export{ye as default};
