import{r as a,j as s,l as me,d as u,y as c}from"./index-BkDEBjE8.js";import{P as I}from"./plus-BGK2cbvf.js";import{S as xe}from"./square-pen-C4tonUcb.js";import{T as ge}from"./trash-2-CdA9fu54.js";import{X as ue}from"./x-DqPZ4nVi.js";import"./createLucideIcon-3adLFeee.js";function Ne(){const[o,T]=a.useState([]),[j,X]=a.useState([]),[G,H]=a.useState([]),[J,A]=a.useState(!0),[p,K]=a.useState(""),[Q,L]=a.useState([]),[m,S]=a.useState(""),[b,N]=a.useState([]),[y,k]=a.useState([]),[B,h]=a.useState([]),[V,v]=a.useState(!1),[C,_]=a.useState(null),[w,D]=a.useState(""),[E,f]=a.useState([""]),[W,P]=a.useState(!1),[F,M]=a.useState(null);a.useEffect(()=>{(async()=>{A(!0),await Promise.all([U(),R(),Y()]),A(!1)})()},[]);const U=async()=>{try{const e=await u.get("/cities");T(e.data||[])}catch{c.error("Failed to load cities")}},R=async()=>{try{const r=(await u.get("/users")).data.map(t=>({...t,board_lists:t.board_lists||[]}));X(r)}catch{c.error("Failed to load users")}},Y=async()=>{try{const e=await u.get("/roles");H(e.data||[])}catch{c.error("Failed to load roles")}};a.useEffect(()=>{if(!p){L([]),S(""),$();return}const e=j.filter(r=>{var t;return((t=r.role)==null?void 0:t.id)===p});L(e),S(""),$()},[p,j]),a.useEffect(()=>{var r,t,l;if(!m){$();return}const e=j.find(i=>i.id===m);e&&(N(((r=e.cities)==null?void 0:r.map(i=>i.id))||[]),k(((t=e.boards)==null?void 0:t.map(i=>i.id))||[]),h(((l=e.board_lists)==null?void 0:l.map(i=>i.id))||[]))},[m,j]);const $=()=>{N([]),k([]),h([])},Z=e=>{N(r=>{if(r.includes(e)){const t=o.find(n=>n.id===e);if(!t)return r;const l=t.boards.map(n=>n.id),i=t.boards.flatMap(n=>{var x;return((x=n.lists)==null?void 0:x.map(d=>d.id))||[]});return k(n=>n.filter(x=>!l.includes(x))),h(n=>n.filter(x=>!i.includes(x))),r.filter(n=>n!==e)}return[...r,e]})},ee=e=>{k(r=>{var n,x;if(r.includes(e)){const d=o.flatMap(g=>g.boards).find(g=>g.id===e),z=((n=d==null?void 0:d.lists)==null?void 0:n.map(g=>g.id))||[];return h(g=>g.filter(ce=>!z.includes(ce))),r.filter(g=>g!==e)}const t=o.flatMap(d=>d.boards).find(d=>d.id===e),l=((x=t==null?void 0:t.lists)==null?void 0:x.map(d=>d.id))||[];l.length>0&&h(d=>[...new Set([...d,...l])]);const i=o.find(d=>d.boards.some(z=>z.id===e));return i&&!b.includes(i.id)&&N(d=>[...d,i.id]),[...r,e]})},se=e=>{h(r=>r.includes(e)?r.filter(t=>t!==e):[...r,e])},re=async()=>{if(m)try{await Promise.all([u.patch(`/users/${m}/cities`,{cities:b}),u.patch(`/users/${m}/boards`,{boards:y}),u.patch(`/users/${m}/lists`,{lists:B})]),c.success("Permissions updated"),R()}catch{c.error("Failed to save permissions")}},te=()=>{_(null),D(""),f([""]),v(!0)},O=e=>{_(e),D(e.name),f(e.boards.map(r=>r.name)),v(!0)},ae=async()=>{var r,t;if(!w.trim()){c.error("City name is required");return}const e=E.filter(l=>l.trim()!=="");try{C?(await u.put(`/cities/${C.id}`,{name:w.trim(),boards:e}),c.success("City updated")):(await u.post("/cities",{name:w.trim(),boards:e}),c.success("City created")),v(!1),U()}catch(l){c.error(((t=(r=l.response)==null?void 0:r.data)==null?void 0:t.message)||"Failed to save city")}},de=e=>{M(e),P(!0)},le=async()=>{if(F)try{await u.delete(`/cities/${F}`),c.success("City deleted"),U()}catch{c.error("Failed to delete city")}finally{P(!1),M(null)}},ie=()=>{f(e=>[...e,""])},ne=e=>{f(r=>r.filter((t,l)=>l!==e))},oe=(e,r)=>{f(t=>t.map((l,i)=>i===e?r:l))},q=e=>e?new Date(e).toLocaleDateString():"—";return J?s.jsx("div",{className:"p-10 text-center text-gray-500",children:"Loading cities & users..."}):s.jsxs("div",{className:"p-5 lg:p-6 bg-white dark:bg-gray-900 rounded-2xl border border-gray-200 dark:border-gray-700 max-w-[1100px] mx-auto",children:[s.jsx(me,{position:"top-right",autoClose:3e3,theme:"colored"}),s.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6",children:[s.jsx("h1",{className:"text-2xl font-bold text-gray-900 dark:text-gray-100",children:"Cities & Access Control"}),s.jsxs("button",{onClick:te,className:"flex items-center gap-2 px-5 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition",children:[s.jsx(I,{size:18})," New City"]})]}),s.jsxs("div",{className:"mb-10 p-5 border rounded-xl bg-gray-50/50 dark:bg-gray-800/40 dark:border-gray-700",children:[s.jsx("h2",{className:"text-lg font-semibold mb-4 text-gray-800 dark:text-gray-200",children:"Assign Permissions"}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-5 mb-6",children:[s.jsxs("div",{children:[s.jsx("label",{className:"block mb-1.5 font-medium text-gray-700 dark:text-gray-300",children:"Role"}),s.jsxs("select",{value:p,onChange:e=>K(Number(e.target.value)||""),className:"w-full px-4 py-2.5 border rounded-lg dark:bg-gray-800 dark:border-gray-700 dark:text-gray-200 focus:ring-2 focus:ring-blue-500",children:[s.jsx("option",{value:"",children:"— Select Role —"}),G.map(e=>s.jsx("option",{value:e.id,children:e.name},e.id))]})]}),p&&s.jsxs("div",{children:[s.jsx("label",{className:"block mb-1.5 font-medium text-gray-700 dark:text-gray-300",children:"User"}),s.jsxs("select",{value:m,onChange:e=>S(Number(e.target.value)||""),className:"w-full px-4 py-2.5 border rounded-lg dark:bg-gray-800 dark:border-gray-700 dark:text-gray-200 focus:ring-2 focus:ring-blue-500",children:[s.jsx("option",{value:"",children:"— Select User —"}),Q.map(e=>s.jsxs("option",{value:e.id,children:[e.first_name," ",e.last_name," • ",e.email]},e.id))]})]})]}),m&&s.jsxs("div",{className:"space-y-7",children:[s.jsxs("div",{children:[s.jsx("h3",{className:"font-medium mb-2.5 text-gray-800 dark:text-gray-200",children:"Cities"}),s.jsx("div",{className:"flex flex-wrap gap-2.5",children:o.map(e=>s.jsxs("label",{className:`flex items-center gap-2 px-4 py-2 border rounded-lg cursor-pointer text-sm transition-all ${b.includes(e.id)?"bg-blue-100 border-blue-400 dark:bg-blue-950/50 dark:border-blue-600":"hover:bg-gray-100 dark:hover:bg-gray-800 border-gray-300 dark:border-gray-600"}`,children:[s.jsx("input",{type:"checkbox",checked:b.includes(e.id),onChange:()=>Z(e.id),className:"h-4 w-4 rounded text-blue-600"}),s.jsx("span",{className:"font-medium",children:e.name}),s.jsxs("span",{className:"text-xs text-gray-500 dark:text-gray-400",children:["(",e.boards.length,")"]})]},e.id))})]}),b.length>0&&s.jsxs("div",{children:[s.jsx("h3",{className:"font-medium mb-2.5 text-gray-800 dark:text-gray-200",children:"Boards"}),o.filter(e=>b.includes(e.id)).map(e=>s.jsxs("div",{className:"mb-5 pl-4 border-l-2 border-gray-200 dark:border-gray-700",children:[s.jsx("p",{className:"font-medium text-gray-700 dark:text-gray-300 mb-2",children:e.name}),s.jsx("div",{className:"flex flex-wrap gap-2.5",children:e.boards.map(r=>s.jsxs("label",{className:`flex items-center gap-2 px-4 py-2 border rounded-lg cursor-pointer text-sm transition-all ${y.includes(r.id)?"bg-indigo-100 border-indigo-400 dark:bg-indigo-950/50 dark:border-indigo-600":"hover:bg-gray-100 dark:hover:bg-gray-800 border-gray-300 dark:border-gray-600"}`,children:[s.jsx("input",{type:"checkbox",checked:y.includes(r.id),onChange:()=>ee(r.id),className:"h-4 w-4 rounded text-indigo-600"}),s.jsx("span",{children:r.name})]},r.id))})]},e.id))]}),y.length>0&&s.jsxs("div",{children:[s.jsx("h3",{className:"font-medium mb-2.5 text-gray-800 dark:text-gray-200",children:"Lists"}),o.flatMap(e=>e.boards).filter(e=>y.includes(e.id)).map(e=>s.jsxs("div",{className:"mb-5 pl-8",children:[s.jsx("p",{className:"text-sm font-medium text-gray-600 dark:text-gray-400 mb-1.5",children:e.name}),s.jsx("div",{className:"flex flex-wrap gap-2.5",children:(e.lists||[]).map(r=>s.jsxs("label",{className:`flex items-center gap-2 px-4 py-2 border rounded-lg cursor-pointer text-sm transition-all ${B.includes(r.id)?"bg-purple-100 border-purple-400 dark:bg-purple-950/50 dark:border-purple-600":"hover:bg-gray-100 dark:hover:bg-gray-800 border-gray-300 dark:border-gray-600"}`,children:[s.jsx("input",{type:"checkbox",checked:B.includes(r.id),onChange:()=>se(r.id),className:"h-4 w-4 rounded text-purple-600"}),s.jsx("span",{children:r.title})]},r.id))})]},e.id))]}),s.jsx("button",{onClick:re,className:"px-6 py-2.5 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition",children:"Save Permissions"})]})]}),s.jsx("div",{className:"overflow-x-auto rounded-xl border border-gray-200 dark:border-gray-700",children:s.jsxs("table",{className:"min-w-full bg-white dark:bg-gray-900",children:[s.jsx("thead",{className:"bg-gray-50 dark:bg-gray-800 border-b",children:s.jsxs("tr",{children:[s.jsx("th",{className:"px-6 py-4 text-left border-r",children:"City Name"}),s.jsx("th",{className:"px-6 py-4 text-left border-r",children:"Boards"}),s.jsx("th",{className:"px-6 py-4 text-left border-r",children:"Created"}),s.jsx("th",{className:"px-6 py-4 text-left border-r",children:"Updated"}),s.jsx("th",{className:"px-6 py-4 text-left",children:"Action"})]})}),s.jsx("tbody",{children:o.length===0?s.jsx("tr",{children:s.jsx("td",{colSpan:5,className:"px-6 py-10 text-center text-gray-500 dark:text-gray-400",children:"No cities found"})}):o.map(e=>s.jsxs("tr",{className:"border-t",children:[s.jsx("td",{className:"px-6 py-4 border-r",children:e.name}),s.jsx("td",{className:"px-6 py-4 border-r",children:e.boards.map(r=>r.name).join(", ")||"—"}),s.jsx("td",{className:"px-6 py-4 border-r",children:q(e.created_at)}),s.jsx("td",{className:"px-6 py-4 border-r",children:q(e.updated_at)}),s.jsxs("td",{className:"px-6 py-4 flex gap-2",children:[s.jsx("button",{onClick:()=>O(e),className:"p-2 bg-yellow-100 hover:bg-yellow-200 rounded dark:bg-yellow-900/40 dark:hover:bg-yellow-800/60",title:"Edit",children:s.jsx(xe,{size:16,className:"text-yellow-700 dark:text-yellow-400"})}),s.jsx("button",{onClick:()=>de(e.id),className:"p-2 bg-red-100 hover:bg-red-200 rounded dark:bg-red-900/40 dark:hover:bg-red-800/60",title:"Delete",children:s.jsx(ge,{size:16,className:"text-red-700 dark:text-red-400"})})]})]},e.id))})]})}),V&&s.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:s.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl p-6 w-[420px]",children:[s.jsx("h3",{className:"text-xl font-bold mb-4",children:C?"Edit City":"Add City"}),!C&&s.jsxs("select",{value:"new",onChange:e=>{if(e.target.value!=="new"){const r=o.find(t=>t.id===Number(e.target.value));r&&O(r)}},className:"w-full mb-4 px-4 py-2 border rounded dark:bg-gray-800 dark:border-gray-700 dark:text-gray-200",children:[s.jsx("option",{value:"new",children:"Create New City"}),o.map(e=>s.jsx("option",{value:e.id,children:e.name},e.id))]}),s.jsx("input",{value:w,onChange:e=>D(e.target.value),className:"w-full mb-4 px-4 py-2 border rounded dark:bg-gray-800 dark:border-gray-700 dark:text-gray-200",placeholder:"City name"}),s.jsxs("div",{className:"mb-4",children:[s.jsx("p",{className:"font-medium mb-2",children:"Boards"}),E.map((e,r)=>s.jsxs("div",{className:"flex gap-2 mb-2",children:[s.jsx("input",{value:e,onChange:t=>oe(r,t.target.value),className:"flex-1 px-3 py-2 border rounded dark:bg-gray-800 dark:border-gray-700 dark:text-gray-200",placeholder:`Board ${r+1}`}),E.length>1&&s.jsx("button",{onClick:()=>ne(r),className:"p-2 bg-red-100 hover:bg-red-200 rounded dark:bg-red-900/40 dark:hover:bg-red-800/50",children:s.jsx(ue,{size:14})})]},r)),s.jsxs("button",{onClick:ie,className:"text-sm text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 mt-2 flex items-center gap-1",children:[s.jsx(I,{size:14})," Add Board"]})]}),s.jsxs("div",{className:"flex gap-3",children:[s.jsx("button",{onClick:()=>v(!1),className:"flex-1 border py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 dark:border-gray-600",children:"Cancel"}),s.jsx("button",{onClick:ae,className:"flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded font-medium",children:"Save"})]})]})}),W&&s.jsx("div",{className:"fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4",children:s.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl p-6 w-full max-w-sm",children:[s.jsx("h3",{className:"text-lg font-bold mb-4",children:"Confirm Delete"}),s.jsxs("p",{className:"mb-6 text-gray-700 dark:text-gray-300",children:["Delete this city?",s.jsx("br",{}),s.jsx("span",{className:"text-red-600 font-medium",children:"All boards and lists will be permanently removed."})]}),s.jsxs("div",{className:"flex gap-3",children:[s.jsx("button",{onClick:()=>P(!1),className:"flex-1 py-2.5 border rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700",children:"Cancel"}),s.jsx("button",{onClick:le,className:"flex-1 bg-red-600 hover:bg-red-700 text-white py-2.5 rounded-lg font-medium",children:"Delete"})]})]})})]})}export{Ne as default};
